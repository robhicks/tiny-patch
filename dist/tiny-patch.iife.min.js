var TinyPatch=function(e){"use strict";function t(e,n){if(e===n)return!0;var r,o=Array.isArray(e),a=Array.isArray(n);if(o&&a){if(e.length!==n.length)return!1;for(r=0;r<e.length;r++)if(!t(e[r],n[r]))return!1;return!0}if(o!==a)return!1;if(e&&n&&"object"==typeof e&&"object"==typeof n){var i=Object.keys(e);if(i.length!==Object.keys(n).length)return!1;var u=e instanceof Date,p=n instanceof Date;if(u&&p)return e.getTime()===n.getTime();if(u!==p)return!1;var c=e instanceof RegExp,f=n instanceof RegExp;if(c&&f)return e.toString()===n.toString();if(c!==f)return!1;for(r=0;r<i.length;r++)if(!Object.prototype.hasOwnProperty.call(n,i[r]))return!1;for(r=0;r<i.length;r++)if(!t(e[i[r]],n[i[r]]))return!1;return!0}return!1}var n=Object.prototype.hasOwnProperty;function r(e,t){return n.call(e,t)}function o(e){if(Array.isArray(e)){for(var t=new Array(e.length),n=0;n<t.length;n++)t[n]=""+n;return t}if(Object.keys)return Object.keys(e);var o=[];for(var a in e)r(e,a)&&o.push(a);return o}function a(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function i(e){for(var t,n=0,r=e.length;n<r;){if(!((t=e.charCodeAt(n))>=48&&t<=57))return!1;n++}return!0}function u(e){return-1===e.indexOf("/")&&-1===e.indexOf("~")?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function p(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}var c=function(e){function t(t,n,r,o,a){e.call(this,t),this.message=t,this.name=n,this.index=r,this.operation=o,this.tree=a}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(Error),f=c,s={add:function(e,t,n){return e[t]=this.value,{newDocument:n}},remove:function(e,t,n){var r=e[t];return delete e[t],{newDocument:n,removed:r}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:function(e,t,n){var r=v(n,this.path);r&&(r=a(r));var o=l(n,{op:"remove",path:this.from}).removed;return l(n,{op:"add",path:this.path,value:o}),{newDocument:n,removed:r}},copy:function(e,t,n){var r=v(n,this.from);return l(n,{op:"add",path:this.path,value:a(r)}),{newDocument:n}},test:function(e,n,r){return{newDocument:r,test:t(e[n],this.value)}},_get:function(e,t,n){return this.value=e[t],{newDocument:n}}},h={add:function(e,t,n){return i(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:n,index:t}},remove:function(e,t,n){return{newDocument:n,removed:e.splice(t,1)[0]}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:s.move,copy:s.copy,test:s.test,_get:s._get};function v(e,t){if(""==t)return e;var n={op:"_get",path:t};return l(e,n),n.value}function l(e,n,r,o){if(void 0===r&&(r=!1),void 0===o&&(o=!0),r&&("function"==typeof r?r(n,0,e,n.path):m(n,0)),""===n.path){var u={newDocument:e};if("add"===n.op)return u.newDocument=n.value,u;if("replace"===n.op)return u.newDocument=n.value,u.removed=e,u;if("move"===n.op||"copy"===n.op)return u.newDocument=v(e,n.from),"move"===n.op&&(u.removed=e),u;if("test"===n.op){if(u.test=t(e,n.value),!1===u.test)throw new f("Test operation failed","TEST_OPERATION_FAILED",0,n,e);return u.newDocument=e,u}if("remove"===n.op)return u.removed=e,u.newDocument=null,u;if("_get"===n.op)return n.value=e,u;if(r)throw new f("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",0,n,e);return u}o||(e=a(e));var c,l,d=(n.path||"").split("/"),w=e,E=1,O=d.length,y=void 0;for(l="function"==typeof r?r:m;;){if(c=d[E],r&&void 0===y&&(void 0===w[c]?y=d.slice(0,E).join("/"):E==O-1&&(y=n.path),void 0!==y&&l(n,0,e,y)),E++,Array.isArray(w)){if("-"===c)c=w.length;else{if(r&&!i(c))throw new f("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",0,n.path,n);i(c)&&(c=~~c)}if(E>=O){if(r&&"add"===n.op&&c>w.length)throw new f("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",0,n.path,n);var A=h[n.op].call(n,w,c,e);if(!1===A.test)throw new f("Test operation failed","TEST_OPERATION_FAILED",0,n,e);return A}}else if(c&&-1!=c.indexOf("~")&&(c=p(c)),E>=O){var g=s[n.op].call(n,w,c,e);if(!1===g.test)throw new f("Test operation failed","TEST_OPERATION_FAILED",0,n,e);return g}w=w[c]}}function d(e,t,n,r){if(void 0===r&&(r=!0),n&&!Array.isArray(t))throw new f("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(e=a(e));for(var o=new Array(t.length),i=0,u=t.length;i<u;i++)o[i]=l(e,t[i],n),e=o[i].newDocument;return o.newDocument=e,o}function m(e,t,n,r){if("object"!=typeof e||null===e||Array.isArray(e))throw new f("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,n);if(!s[e.op])throw new f("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,n);if("string"!=typeof e.path)throw new f("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,n);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new f('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,n);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new f("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new f("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&function e(t){if(void 0===t)return!0;if(t)if(Array.isArray(t)){for(var n=0,r=t.length;n<r;n++)if(e(t[n]))return!0}else if("object"==typeof t)for(var a=o(t),i=a.length,u=0;u<i;u++)if(e(t[a[u]]))return!0;return!1}(e.value))throw new f("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,n);if(n)if("add"==e.op){var a=e.path.split("/").length,i=r.split("/").length;if(a!==i+1&&a!==i)throw new f("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,n)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==r)throw new f("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,n)}else if("move"===e.op||"copy"===e.op){var u=w([{op:"_get",path:e.from,value:void 0}],n);if(u&&"OPERATION_PATH_UNRESOLVABLE"===u.name)throw new f("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,n)}}function w(e,t,n){try{if(!Array.isArray(e))throw new f("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)d(a(t),a(e),n||!0);else{n=n||m;for(var r=0;r<e.length;r++)n(e[r],r,t,void 0)}}catch(e){if(e instanceof f)return e;throw e}}var E=[],O=function(e){this.observers=[],this.obj=e},y=function(e,t){this.callback=e,this.observer=t};function A(e){for(var t,n=0,r=E.length;n<r;n++)if(E[n].obj===e.object){t=E[n];break}g(t.value,e.object,e.patches,""),e.patches.length&&d(t.value,e.patches);var o=e.patches;return o.length>0&&(e.patches=[],e.callback&&e.callback(o)),o}function g(e,t,n,i){if(t!==e){"function"==typeof t.toJSON&&(t=t.toJSON());for(var p=o(t),c=o(e),f=!1,s=c.length-1;s>=0;s--){var h=c[s],v=e[h];if(!r(t,h)||void 0===t[h]&&void 0!==v&&!1===Array.isArray(t))n.push({op:"remove",path:i+"/"+u(h)}),f=!0;else{var l=t[h];"object"==typeof v&&null!=v&&"object"==typeof l&&null!=l?g(v,l,n,i+"/"+u(h)):v!==l&&n.push({op:"replace",path:i+"/"+u(h),value:a(l)})}}if(f||p.length!=c.length)for(var d=0;d<p.length;d++){var m=p[d];r(e,m)||void 0===t[m]||n.push({op:"add",path:i+"/"+u(m),value:a(t[m])})}}}return e.unobserve=function(e,t){t.unobserve()},e.observe=function(e,t){var n,r=function(e){for(var t=0,n=E.length;t<n;t++)if(E[t].obj===e)return E[t]}(e);if(r?n=function(e,t){for(var n=0,r=e.observers.length;n<r;n++)if(e.observers[n].callback===t)return e.observers[n].observer}(r,t):(r=new O(e),E.push(r)),n)return n;if(n={},r.value=a(e),t){n.callback=t,n.next=null;var o=function(){A(n)},i=function(){clearTimeout(n.next),n.next=setTimeout(o)};"undefined"!=typeof window&&(window.addEventListener?(window.addEventListener("mouseup",i),window.addEventListener("keyup",i),window.addEventListener("mousedown",i),window.addEventListener("keydown",i),window.addEventListener("change",i)):(document.documentElement.attachEvent("onmouseup",i),document.documentElement.attachEvent("onkeyup",i),document.documentElement.attachEvent("onmousedown",i),document.documentElement.attachEvent("onkeydown",i),document.documentElement.attachEvent("onchange",i)))}return n.patches=[],n.object=e,n.unobserve=function(){A(n),clearTimeout(n.next),function(e,t){for(var n=0,r=e.observers.length;n<r;n++)if(e.observers[n].observer===t)return void e.observers.splice(n,1)}(r,n),"undefined"!=typeof window&&(window.removeEventListener?(window.removeEventListener("mouseup",fastCheck),window.removeEventListener("keyup",fastCheck),window.removeEventListener("mousedown",fastCheck),window.removeEventListener("keydown",fastCheck)):(document.documentElement.detachEvent("onmouseup",fastCheck),document.documentElement.detachEvent("onkeyup",fastCheck),document.documentElement.detachEvent("onmousedown",fastCheck),document.documentElement.detachEvent("onkeydown",fastCheck)))},r.observers.push(new y(t,n)),n},e.generate=A,e.compare=function(e,t){var n=[];return g(e,t,n,""),n},e.applyOperation=l,e.applyPatch=d,e.applyReducer=function(e,t){var n=l(e,t);if(!1===n.test)throw new f("Test operation failed","TEST_OPERATION_FAILED",0,t,e);return n.newDocument},e.getValueByPointer=v,e.validate=w,e.validator=m,e.JsonPatchError=c,e.deepClone=a,e.escapePathComponent=u,e.unescapePathComponent=p,e}({});
