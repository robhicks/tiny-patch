function equal(e,t){if(e===t)return!0;let n,r=Array.isArray(e),o=Array.isArray(t);if(r&&o){if(e.length!==t.length)return!1;for(n=0;n<e.length;n++)if(!equal(e[n],t[n]))return!1;return!0}if(r!==o)return!1;if(e&&t&&"object"==typeof e&&"object"==typeof t){let r=Object.keys(e);if(r.length!==Object.keys(t).length)return!1;let o=e instanceof Date,a=t instanceof Date;if(o&&a)return e.getTime()===t.getTime();if(o!==a)return!1;let i=e instanceof RegExp,p=t instanceof RegExp;if(i&&p)return e.toString()===t.toString();if(i!==p)return!1;for(n=0;n<r.length;n++)if(!Object.prototype.hasOwnProperty.call(t,r[n]))return!1;for(n=0;n<r.length;n++)if(!equal(e[r[n]],t[r[n]]))return!1;return!0}return!1}function hasOwnProperty(e,t){return _hasOwnProperty.call(e,t)}function _objectKeys(e){if(Array.isArray(e)){let t=new Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let n in e)hasOwnProperty(e,n)&&t.push(n);return t}function _deepClone(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function isInteger(e){let t,n=0,r=e.length;for(;n<r;){if(!((t=e.charCodeAt(n))>=48&&t<=57))return!1;n++}return!0}function escapePathComponent(e){return-1===e.indexOf("/")&&-1===e.indexOf("~")?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function unescapePathComponent(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function hasUndefined(e){if(void 0===e)return!0;if(e)if(Array.isArray(e)){for(let t=0,n=e.length;t<n;t++)if(hasUndefined(e[t]))return!0}else if("object"==typeof e){let t=_objectKeys(e),n=t.length;for(let r=0;r<n;r++)if(hasUndefined(e[t[r]]))return!0}return!1}function getValueByPointer(e,t){if(""==t)return e;let n={op:"_get",path:t};return applyOperation(e,n),n.value}function applyOperation(e,t,n=!1,r=!0){if(n&&("function"==typeof n?n(t,0,e,t.path):validator(t,0)),""===t.path){let r={newDocument:e};if("add"===t.op)return r.newDocument=t.value,r;if("replace"===t.op)return r.newDocument=t.value,r.removed=e,r;if("move"===t.op||"copy"===t.op)return r.newDocument=getValueByPointer(e,t.from),"move"===t.op&&(r.removed=e),r;if("test"===t.op){if(r.test=equal(e,t.value),!1===r.test)throw new JsonPatchError("Test operation failed","TEST_OPERATION_FAILED",0,t,e);return r.newDocument=e,r}if("remove"===t.op)return r.removed=e,r.newDocument=null,r;if("_get"===t.op)return t.value=e,r;if(n)throw new JsonPatchError("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",0,t,e);return r}{r||(e=_deepClone(e));const o=t.path||"",a=o.split("/");let i,p,s=e,c=1,u=a.length,f=void 0;for(p="function"==typeof n?n:validator;;){if(i=a[c],n&&void 0===f&&(void 0===s[i]?f=a.slice(0,c).join("/"):c==u-1&&(f=t.path),void 0!==f&&p(t,0,e,f)),c++,Array.isArray(s)){if("-"===i)i=s.length;else{if(n&&!isInteger(i))throw new JsonPatchError("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",0,t.path,t);isInteger(i)&&(i=~~i)}if(c>=u){if(n&&"add"===t.op&&i>s.length)throw new JsonPatchError("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",0,t.path,t);const r=arrOps[t.op].call(t,s,i,e);if(!1===r.test)throw new JsonPatchError("Test operation failed","TEST_OPERATION_FAILED",0,t,e);return r}}else if(i&&-1!=i.indexOf("~")&&(i=unescapePathComponent(i)),c>=u){const n=objOps[t.op].call(t,s,i,e);if(!1===n.test)throw new JsonPatchError("Test operation failed","TEST_OPERATION_FAILED",0,t,e);return n}s=s[i]}}}function applyPatch(e,t,n,r=!0){if(n&&!Array.isArray(t))throw new JsonPatchError("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(e=_deepClone(e));const o=new Array(t.length);for(let r=0,a=t.length;r<a;r++)o[r]=applyOperation(e,t[r],n),e=o[r].newDocument;return o.newDocument=e,o}function applyReducer(e,t){const n=applyOperation(e,t);if(!1===n.test)throw new JsonPatchError("Test operation failed","TEST_OPERATION_FAILED",0,t,e);return n.newDocument}function validator(e,t,n,r){if("object"!=typeof e||null===e||Array.isArray(e))throw new JsonPatchError("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,n);if(!objOps[e.op])throw new JsonPatchError("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,n);if("string"!=typeof e.path)throw new JsonPatchError("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,n);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new JsonPatchError('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,n);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new JsonPatchError("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new JsonPatchError("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&hasUndefined(e.value))throw new JsonPatchError("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,n);if(n)if("add"==e.op){let o=e.path.split("/").length,a=r.split("/").length;if(o!==a+1&&o!==a)throw new JsonPatchError("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,n)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==r)throw new JsonPatchError("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,n)}else if("move"===e.op||"copy"===e.op){let r={op:"_get",path:e.from,value:void 0},o=validate([r],n);if(o&&"OPERATION_PATH_UNRESOLVABLE"===o.name)throw new JsonPatchError("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,n)}}function validate(e,t,n){try{if(!Array.isArray(e))throw new JsonPatchError("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)applyPatch(_deepClone(t),_deepClone(e),n||!0);else{n=n||validator;for(let r=0;r<e.length;r++)n(e[r],r,t,void 0)}}catch(e){if(e instanceof JsonPatchError)return e;throw e}}function getMirror(e){for(let t=0,n=beforeDict.length;t<n;t++)if(beforeDict[t].obj===e)return beforeDict[t]}function getObserverFromMirror(e,t){for(let n=0,r=e.observers.length;n<r;n++)if(e.observers[n].callback===t)return e.observers[n].observer}function removeObserverFromMirror(e,t){for(let n=0,r=e.observers.length;n<r;n++)if(e.observers[n].observer===t)return void e.observers.splice(n,1)}function unobserve(e,t){t.unobserve()}function observe(e,t){let n,r=[],o=getMirror(e);if(o?n=getObserverFromMirror(o,t):(o=new Mirror(e),beforeDict.push(o)),n)return n;if(n={},o.value=_deepClone(e),t){n.callback=t,n.next=null;let e=()=>{generate(n)},r=()=>{clearTimeout(n.next);n.next=setTimeout(e)};"undefined"!=typeof window&&(window.addEventListener?(window.addEventListener("mouseup",r),window.addEventListener("keyup",r),window.addEventListener("mousedown",r),window.addEventListener("keydown",r),window.addEventListener("change",r)):(document.documentElement.attachEvent("onmouseup",r),document.documentElement.attachEvent("onkeyup",r),document.documentElement.attachEvent("onmousedown",r),document.documentElement.attachEvent("onkeydown",r),document.documentElement.attachEvent("onchange",r)))}return n.patches=r,n.object=e,n.unobserve=(()=>{generate(n);clearTimeout(n.next);removeObserverFromMirror(o,n);"undefined"!=typeof window&&(window.removeEventListener?(window.removeEventListener("mouseup",fastCheck),window.removeEventListener("keyup",fastCheck),window.removeEventListener("mousedown",fastCheck),window.removeEventListener("keydown",fastCheck)):(document.documentElement.detachEvent("onmouseup",fastCheck),document.documentElement.detachEvent("onkeyup",fastCheck),document.documentElement.detachEvent("onmousedown",fastCheck),document.documentElement.detachEvent("onkeydown",fastCheck)))}),o.observers.push(new ObserverInfo(t,n)),n}function generate(e){let t;for(let n=0,r=beforeDict.length;n<r;n++)if(beforeDict[n].obj===e.object){t=beforeDict[n];break}_generate(t.value,e.object,e.patches,""),e.patches.length&&applyPatch(t.value,e.patches);let n=e.patches;return n.length>0&&(e.patches=[],e.callback&&e.callback(n)),n}function _generate(e,t,n,r){if(t!==e){"function"==typeof t.toJSON&&(t=t.toJSON());let o=_objectKeys(t),a=_objectKeys(e),i=!1;for(let o=a.length-1;o>=0;o--){let p=a[o],s=e[p];if(!hasOwnProperty(t,p)||void 0===t[p]&&void 0!==s&&!1===Array.isArray(t))n.push({op:"remove",path:r+"/"+escapePathComponent(p)}),i=!0;else{let e=t[p];"object"==typeof s&&null!=s&&"object"==typeof e&&null!=e?_generate(s,e,n,r+"/"+escapePathComponent(p)):s!==e&&n.push({op:"replace",path:r+"/"+escapePathComponent(p),value:_deepClone(e)})}}if(i||o.length!=a.length)for(let a=0;a<o.length;a++){let i=o[a];hasOwnProperty(e,i)||void 0===t[i]||n.push({op:"add",path:r+"/"+escapePathComponent(i),value:_deepClone(t[i])})}}}function compare(e,t){let n=[];return _generate(e,t,n,""),n}const _hasOwnProperty=Object.prototype.hasOwnProperty;class PatchError extends Error{constructor(e,t,n,r,o){super(e),this.message=e,this.name=t,this.index=n,this.operation=r,this.tree=o}}const JsonPatchError=PatchError,objOps={add:function(e,t,n){return e[t]=this.value,{newDocument:n}},remove:function(e,t,n){let r=e[t];return delete e[t],{newDocument:n,removed:r}},replace:function(e,t,n){let r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:function(e,t,n){let r=getValueByPointer(n,this.path);r&&(r=_deepClone(r));const o=applyOperation(n,{op:"remove",path:this.from}).removed;return applyOperation(n,{op:"add",path:this.path,value:o}),{newDocument:n,removed:r}},copy:function(e,t,n){const r=getValueByPointer(n,this.from);return applyOperation(n,{op:"add",path:this.path,value:_deepClone(r)}),{newDocument:n}},test:function(e,t,n){return{newDocument:n,test:equal(e[t],this.value)}},_get:function(e,t,n){return this.value=e[t],{newDocument:n}}};let arrOps={add:function(e,t,n){return isInteger(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:n,index:t}},remove:function(e,t,n){return{newDocument:n,removed:e.splice(t,1)[0]}},replace:function(e,t,n){let r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:objOps.move,copy:objOps.copy,test:objOps.test,_get:objOps._get},beforeDict=[];class Mirror{constructor(e){this.observers=[],this.obj=e}}class ObserverInfo{constructor(e,t){this.callback=e,this.observer=t}}export{unobserve,observe,generate,compare,applyOperation,applyPatch,applyReducer,getValueByPointer,validate,validator,PatchError as JsonPatchError,_deepClone as deepClone,escapePathComponent,unescapePathComponent};
